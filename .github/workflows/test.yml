name: Test
on:
    push:
        branches:
            - master
            - develop
    pull_request:
        types:
            - ready_for_review
            - synchronize
            - opened
jobs:
    app:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/app
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-app
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild

            - name: Test App
              env:
                  COVERAGE_THRESHOLD_LINES: 100
                  COVERAGE_THRESHOLD_FUNCTIONS: 100
                  COVERAGE_THRESHOLD_STATEMENTS: 100
                  COVERAGE_THRESHOLD_BRANCHES:
                  # TODO: include validations coverage
                  COVERAGE_INCLUDE_PATH: src/app/App*
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage src/app/App* src/app/App.test.tsx src/app/validations

            - name: Test Context Providers
              env:
                  # TODO: fix threshold
                  COVERAGE_THRESHOLD_LINES: 100
                  COVERAGE_THRESHOLD_FUNCTIONS: 100
                  COVERAGE_THRESHOLD_STATEMENTS: 100
                  COVERAGE_THRESHOLD_BRANCHES: 100
                  COVERAGE_INCLUDE_PATH: src/app/contexts
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/app/contexts

            - name: Test hooks
              env:
                  COVERAGE_THRESHOLD_LINES: 96
                  COVERAGE_THRESHOLD_FUNCTIONS: 95.91
                  COVERAGE_THRESHOLD_STATEMENTS: 96.1
                  COVERAGE_THRESHOLD_BRANCHES: 94.22
                  # TODO: fix add inclusion regex and require full coverage.
                  COVERAGE_INCLUDE_PATH: src/app/hooks
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/app/hooks

            - name: Test Components ^A-O
              env:
                  COVERAGE_THRESHOLD_LINES: 16.23
                  COVERAGE_THRESHOLD_FUNCTIONS: 0.7
                  COVERAGE_THRESHOLD_STATEMENTS: 15.66
                  COVERAGE_THRESHOLD_BRANCHES: 0.55
                  COVERAGE_INCLUDE_PATH: src/app/components/[A-O]*
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm test:coverage src/app/components/[A-O]*

            - name: Test Components ^P-Z
              env:
                  COVERAGE_THRESHOLD_LINES: 15.84
                  COVERAGE_THRESHOLD_FUNCTIONS: 0.61
                  COVERAGE_THRESHOLD_STATEMENTS: 15.26
                  COVERAGE_THRESHOLD_BRANCHES: 0.47
                  COVERAGE_INCLUDE_PATH: src/app/components/[P-Z]*
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm test:coverage src/app/components/[P-Z]*

    domains-contact:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/domains/contact
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-domains-contact
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild
            - name: Test
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/contact
    domains-dashboard:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/domains/dashboard
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-domains-dashboard
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild
            - name: Test
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/dashboard
    domains-error:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/domains/error
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-domains-error
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild
            - name: Test
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/error
    domains-exchange:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/domains/exchange
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-domains-exchange
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild
            - name: Test
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/exchange
    domains-message:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/domains/message
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-domains-message
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild
            - name: Test
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/message
    domains-network:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/domains/network
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-domains-network
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild
            - name: Test
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/network
    domains-news:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/domains/news
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-domains-news
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild
            - name: Test
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/news
    domains-profile:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/domains/profile
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-domains-profile
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild
            - name: Test
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/profile
    domains-setting:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/domains/setting
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-domains-setting
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild
            - name: Test
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/setting

    domains-transaction:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/domains/transaction
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-domains-transaction
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild

            - name: Test Utils
              env:
                  COVERAGE_THRESHOLD_LINES: 75.86
                  COVERAGE_THRESHOLD_FUNCTIONS: 69.23
                  COVERAGE_THRESHOLD_STATEMENTS: 80
                  COVERAGE_THRESHOLD_BRANCHES: 83.33
                  # TODO: fix add inclusion regex and require full coverage.
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest --coverage src/domains/transaction/utils.test.ts src/domains/transaction/routing.test.ts

            - name: Test Components ^A-O
              env:
                  COVERAGE_THRESHOLD_LINES: 13.2
                  COVERAGE_THRESHOLD_FUNCTIONS: 1.08
                  COVERAGE_THRESHOLD_STATEMENTS: 12.96
                  COVERAGE_THRESHOLD_BRANCHES: 1.01
                  COVERAGE_INCLUDE_PATH: src/domains/transaction/components/[A-O]*
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm test:coverage src/domains/transaction/components/[A-O]*

            - name: Test Components ^P-Z
              env:
                  COVERAGE_THRESHOLD_LINES: 13.02
                  COVERAGE_THRESHOLD_FUNCTIONS: 1.23
                  COVERAGE_THRESHOLD_STATEMENTS: 12.93
                  COVERAGE_THRESHOLD_BRANCHES: 1.24
                  COVERAGE_INCLUDE_PATH: src/domains/transaction/components/[P-Z]*
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm test:coverage src/domains/transaction/components/[P-Z]*

            - name: Test Hooks
              env:
                  COVERAGE_THRESHOLD_LINES: 28.87
                  COVERAGE_THRESHOLD_FUNCTIONS: 14.91
                  COVERAGE_THRESHOLD_STATEMENTS: 28.31
                  COVERAGE_THRESHOLD_BRANCHES: 10.57
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/transaction/hooks

            - name: Test Pages
              env:
                  COVERAGE_THRESHOLD_LINES: 65.49
                  COVERAGE_THRESHOLD_FUNCTIONS: 60.99
                  COVERAGE_THRESHOLD_STATEMENTS: 65.31
                  COVERAGE_THRESHOLD_BRANCHES: 52.36
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/transaction/pages

            - name: Test Validations
              env:
                  COVERAGE_THRESHOLD_LINES: 28.52
                  COVERAGE_THRESHOLD_FUNCTIONS: 11.17
                  COVERAGE_THRESHOLD_STATEMENTS: 27.19
                  COVERAGE_THRESHOLD_BRANCHES: 18.43
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/transaction/validations

    domains-vote:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/domains/vote
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-domains-vote
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild
            - name: Test
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/vote
    domains-wallet:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/domains/wallet
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-domains-wallet
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild
            - name: Test
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/domains/wallet
    router:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/router
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-router
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild
            - name: Test
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/router
    utils:
        runs-on: ubuntu-latest
        env:
            COVERAGE_INCLUDE_PATH: src/utils
            COVERAGE_THRESHOLD_LINES: 25
            COVERAGE_THRESHOLD_BRANCHES: 25
            COVERAGE_THRESHOLD_FUNCTIONS: 25
            COVERAGE_THRESHOLD_STATEMENTS: 25
        strategy:
            matrix:
                node-version:
                    - 16.17.1
        concurrency:
            group: ${{ github.head_ref }}-test-utils
            cancel-in-progress: true
        steps:
            - uses: actions/checkout@v2
              with:
                  ref: ${{ github.head_ref }}
            - uses: pnpm/action-setup@v2
              with:
                  version: 7
            - uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - name: Update System
              run: sudo apt-get update
            - name: Install (Ledger Requirements)
              run: sudo apt-get install libudev-dev libusb-1.0-0-dev
            - name: Install (pnpm)
              run: pnpm install --frozen-lockfile
            - name: Rebuild
              run: pnpm rebuild
            - name: Test
              uses: nick-invision/retry@v2
              with:
                  timeout_minutes: 20
                  max_attempts: 1
                  command: pnpm vitest run --coverage --dir src/utils
